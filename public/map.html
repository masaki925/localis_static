<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title></title>
    <script src="http://maps.google.com/maps/api/js?sensor=true" type="text/javascript"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7/jquery.min.js" type="text/javascript"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.10.0/jquery-ui.min.js"></script>

    <script src="https://cdn.jsdelivr.net/jquery.ui.map/3.0rc/min/jquery.ui.map.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/jquery.ui.map/3.0rc/jquery.ui.map.overlays.js"></script>
    <script src="https://cdn.jsdelivr.net/jquery.ui.map/3.0rc/jquery.ui.map.services.js"></script>
    <script src="https://cdn.jsdelivr.net/jquery.ui.map/3.0rc/jquery.ui.map.extensions.js"></script>

    <script src="http://cdn.aldu.net/google.maps.markerwithlabel/1.1.5/markerwithlabel.min.js"></script>

    <script type="text/javascript">
      $(function() {
          // Also works with: var yourStartLatLng = '59.3426606750, 18.0736160278';
          //var yourStartLatLng = new google.maps.LatLng(59.3426606750, 18.0736160278);
          //$('#map_canvas').gmap({'center': yourStartLatLng});

          $('#map_canvas').gmap('autocomplete', 'locality', function(ui) {
                  // ui.item.position <-- selected position (google.maps.LatLng)
          });

        ( function($) {
            $.extend($.ui.gmap.prototype, {
              // This fires after the widgets create method
              _init: function() {
                var self = this;
                // If you add the property option address in the constructor it will be geocoded 
                if ( this.options.address && this.options.callback ) {
                  this.search({'address': this.options.address}, function(results, status) {
                    if ( status === 'OK' ) {
                      self._call(self.options.callback, results, status);
                    }
                  });
                }
              }
            });
        } (jQuery) );


        ( function($) {
          $.extend($.ui.gmap.prototype, {
            /**
             * Autocomplete using Google Geocoder
             * @param panel:string/node/jquery
             * @param callback:function(ui) called whenever something is selected
             */
            // $('#map_canvas').gmap('autocomplete', 'locality', function(ui) { で呼ばれる
            autocomplete: function(panel, callback) {
      
              // ここでいうthis は…? #=> あとでsearch を呼び出してるから、maps とおもわれる
              var self = this;
      
              // $('locality').autocomplete
              $(this._unwrap(panel)).autocomplete({
      
                // source の指定はfunction の結果
                // request はどれ？, response はどれ？ #=> jQuery の仕様。request はinput に入力したテキスト。reponse はサジェストするテキスト
                source: function( request, response ) {
      
                  // gmap のsearch と思われる
                  self.search({'address':request.term}, function(results, status) {
                    if ( status === 'OK' ) {
      
                      // 住所が入った配列が返る
                      //   map は配列のメソッドのmap.
                      response( $.map( results, function(item) {
                        return { label: item.formatted_address, value: item.formatted_address, position: item.geometry.location }
                      }));
                    }
                  });
                },
      
                minLength: 3,
      
                // select すると、callback = function(ui) が呼ばれる
                select: function(event, ui) { 
                  self._call(callback, ui);
                },
                open: function() { $( this ).removeClass( "ui-corner-all" ).addClass( "ui-corner-top" ); },
                close: function() { $( this ).removeClass( "ui-corner-top" ).addClass( "ui-corner-all" ); }
              });
            }
          });
        } (jQuery) );
      });
    </script>
  </head>
  <body>
    <input id="locality" type="text" />

    <div id="map_canvas" style="width:250px;height:250px"></div>
  </body>
</html>
